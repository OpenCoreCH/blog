<!doctype html><html lang=en><head><title>Unicode Normalization Forms: When ö != ö :: Roman's Random Thoughts</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Some time ago, a very weird issue was reported to me about a Nextcloud system. The user uploaded a file with an &ldquo;ö&rdquo; on a SMB share that was configured as an external storage in the Nextcloud server. But when accessing the folder containing the file over WebDAV, it did not appear (no matter which WebDAV client was used). After ruling out the usual causes (wrong permissions, etc&mldr;), I analyzed the network traffic between the WebDAV client and the server and saw that the file name is indeed not returned after issuing a PROPFIND. So I set some breakpoints in the Nextcloud source code to analyze if it is also not returned by the SMB server. It was returned by the SMB server, but when the Nextcloud system requested more metadata for the file (with the path in the request), the SMB server returned a &ldquo;file not found&rdquo; error, which lead Nextcloud to discard the file. How can it happen that the file is first returned by the SMB server when listing files but then the server suddenly reports an error when requesting more metadata?
"><meta name=keywords content="nextcloud,unicode"><meta name=robots content="noodp"><link rel=canonical href=https://blog.opencore.ch/posts/unicode-normalization-forms/><link rel=stylesheet href=https://blog.opencore.ch/assets/style.css><link rel=stylesheet href=https://blog.opencore.ch/assets/blue.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://blog.opencore.ch/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://blog.opencore.ch/img/favicon/blue.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Unicode Normalization Forms: When ö != ö :: Roman's Random Thoughts"><meta property="og:description" content="How special characters in file names can ruin your day."><meta property="og:url" content="https://blog.opencore.ch/posts/unicode-normalization-forms/"><meta property="og:site_name" content="Unicode Normalization Forms: When ö != ö"><meta property="og:image" content="https://blog.opencore.ch/"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2021-06-01 00:00:00 +0000 UTC"></head><body class=blue><div class="container headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Roman's Random Thoughts</div></a></div><div class=menu-trigger>menu</div></div></header><div class=content><div class=post><h1 class=post-title><a href=https://blog.opencore.ch/posts/unicode-normalization-forms/>Unicode Normalization Forms: When ö != ö</a></h1><div class=post-meta><span class=post-date>2021-06-01
</span><span class=post-author>:: Roman Böhringer</span></div><span class=post-tags>#<a href=https://blog.opencore.ch/tags/sre/>sre</a>&nbsp;</span><div class=post-content><div><p>Some time ago, a very weird issue was reported to me about a Nextcloud system. The user uploaded a file with an &ldquo;ö&rdquo; on a SMB share that was configured as an external storage in the Nextcloud server. But when accessing the folder containing the file over WebDAV, it did not appear (no matter which WebDAV client was used). After ruling out the usual causes (wrong permissions, etc&mldr;), I analyzed the network traffic between the WebDAV client and the server and saw that the file name is indeed not returned after issuing a <code>PROPFIND</code>. So I set some breakpoints in the Nextcloud source code to analyze if it is also not returned by the SMB server.
It was returned by the SMB server, but when the Nextcloud system requested more metadata for the file (with the path in the request), the SMB server returned a &ldquo;file not found&rdquo; error, which lead Nextcloud to discard the file.
How can it happen that the file is first returned by the SMB server when listing files but then the server suddenly reports an error when requesting more metadata?</p><p>When looking at the raw bytes of the first (listing) and second (metadata) SMB request, I found the culprit. The SMB server sent the bytes <code>0x6F 0xCC 0x88</code> for the ö, which is <a href=https://www.fileformat.info/info/unicode/char/006f/index.htm>U+006F LATIN SMALL LETTER O</a> and <a href=https://www.fileformat.info/info/unicode/char/0308/index.htm>U+0308 COMBINING DIAERESIS</a>. In the second request, the Nextcloud server sent <code>0xC3 0xB6</code>, which is <a href=https://www.fileformat.info/info/unicode/char/00f6/index.htm>LATIN SMALL LETTER O WITH DIAERESIS</a>. Although the two characters look exactly the same, their code point sequence is different.
This is known as <a href=https://en.wikipedia.org/wiki/Unicode_equivalence>Unicode equivalence</a> and, in theory, addressed by Unicode normalization. But here, normalization caused this issue. Before storing the file name in the cache, Nextcloud normalized the file name (to NFC) in a function <code>normalizePath</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>normalizePath</span>($path, $stripTrailingSlash <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>, $isAbsolutePath <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>, $keepUnicode <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>) {
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>//normalize unicode if possible
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>$keepUnicode) {
</span></span><span style=display:flex><span>			$path <span style=color:#f92672>=</span> <span style=color:#a6e22e>\OC_Util</span><span style=color:#f92672>::</span><span style=color:#a6e22e>normalizeUnicode</span>($path);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>This normalized path is then used for the second request, which fails because the file is stored in a different normalization form (NFD in this case) on the SMB server.</p><p>So what can you do about this? Of course you could write a small script to normalize all your file names to NFC on all shares, but this may not be desirable for large shares with millions of files. But it turns out that I was not the first to experience this problem and there is a &ldquo;NFD compatibility&rdquo; option that can be set on a per-share basis. When it is enabled, the original <a href=https://github.com/owncloud/core/issues/21365#issuecomment-173637039>NFD name is also stored</a> in the cache (which results in additional database queries, the option is therefore not enabled per default).</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://blog.opencore.ch/posts/aws-cpp-sdk-zero-copy-upload/><span class=button__icon>←</span>
<span class=button__text>How to perform zero-copy S3 uploads with the AWS C++ SDK</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2025 Roman Böhringer</span></div></div></footer><script src=https://blog.opencore.ch/assets/main.js></script><script src=https://blog.opencore.ch/assets/prism.js></script></div></body></html>